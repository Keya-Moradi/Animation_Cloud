<div class="container">
  <div class="main-body">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="main-breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">
          <%= name %>'s Profile
        </li>
      </ol>
    </nav>
    <!-- /Breadcrumb -->

    <div class="row gutters-sm">
      <div class="col-md-4 mb-3">
        <div class="card">
          <div class="card-body">
            <div class="d-flex flex-column align-items-center text-center">
              <img
                src="https://bootdey.com/img/Content/avatar/avatar2.png"
                alt="Admin"
                class="rounded-circle"
                width="150"
              />
              <div class="mt-3">
                <h4><%= name %></h4>
                <p class="text-secondary mb-1">Creative Animator</p>
                <button class="btn btn-primary">Follow</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card mb-3">
          <div class="card-body">
            <div class="row">
              <div class="col-sm-3">
                <h6 class="mb-0">Full Name</h6>
              </div>
              <div class="col-sm-9 text-secondary"><%= name %></div>
            </div>
            <hr />
            <div class="row">
              <div class="col-sm-3">
                <h6 class="mb-0">Email</h6>
              </div>
              <div class="col-sm-9 text-secondary"><%= email %></div>
            </div>
            <br />
            <div class="row">
              <div class="col-sm-12">
                <a class="btn btn-info" href="/auth/<%= id %>/edit">Edit Profile</a>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-8">
          <div class="card mb-3">
            <div class="card-body">
              <div class="row">
                <div class="col-sm-12">
                  <h6 class="mb-3">Generate AI Animation</h6>
                </div>
                <div class="col-sm-12">
                  <div class="form-group">
                    <input
                      id="userPromptInput"
                      class="form-control"
                      placeholder="Describe your animation (e.g., 'White tiger in New York')"
                      maxlength="500"
                    />
                    <small class="form-text text-muted">Max 500 characters</small>
                  </div>
                  <br />
                  <button
                    class="btn btn-info btn-block"
                    type="button"
                    onclick="callApi(getUserPrompt())"
                    id="generateBtn"
                  >
                    Generate My Video!
                  </button>
                  <div id="loadingIndicator" style="display: none; margin-top: 15px;">
                    <div class="text-center">
                      <div class="spinner-border text-info" role="status">
                        <span class="sr-only">Loading...</span>
                      </div>
                      <p class="mt-2">Generating your animation... This may take a moment.</p>
                    </div>
                  </div>
                  <div id="messageArea" style="margin-top: 15px;"></div>

                  <script>
                    function getUserPrompt() {
                      const userPromptInput = document.querySelector("#userPromptInput");
                      const userPromptText = userPromptInput.value;
                      return userPromptText;
                    }

                    function showMessage(message, type = 'info') {
                      const messageArea = document.getElementById('messageArea');
                      messageArea.innerHTML = `
                        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                          ${message}
                          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                      `;
                    }

                    function callApi(userPrompt) {
                      if (!userPrompt || userPrompt.trim() === '') {
                        showMessage('Please enter a prompt!', 'warning');
                        return;
                      }

                      const loadingIndicator = document.getElementById('loadingIndicator');
                      const generateBtn = document.getElementById('generateBtn');
                      const messageArea = document.getElementById('messageArea');

                      // Show loading, disable button
                      loadingIndicator.style.display = 'block';
                      generateBtn.disabled = true;
                      messageArea.innerHTML = '';

                      fetch("/api", {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ userPrompt }),
                      })
                        .then((response) => response.json())
                        .then((data) => {
                          loadingIndicator.style.display = 'none';
                          generateBtn.disabled = false;

                          if (data.success) {
                            showMessage(data.message, 'success');
                            // Add video to gallery dynamically
                            setTimeout(() => {
                              location.reload();
                            }, 1500);
                          } else {
                            showMessage(data.error || 'Failed to generate video', 'danger');
                          }
                        })
                        .catch((error) => {
                          loadingIndicator.style.display = 'none';
                          generateBtn.disabled = false;
                          showMessage('Error: ' + error.message, 'danger');
                        });
                    }

                    function deleteVideo(videoId) {
                      if (!confirm('Are you sure you want to delete this video?')) {
                        return;
                      }

                      fetch(`/api/videos/${videoId}`, {
                        method: 'DELETE',
                        headers: {
                          'Content-Type': 'application/json',
                        }
                      })
                      .then(response => response.json())
                      .then(data => {
                        if (data.success) {
                          location.reload();
                        } else {
                          alert(data.error || 'Failed to delete video');
                        }
                      })
                      .catch(error => {
                        alert('Error deleting video: ' + error.message);
                      });
                    }
                  </script>
                </div>
              </div>
            </div>
          </div>

          <div class="row gutters-sm">
            <div class="col-sm-12 mb-3">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="d-flex align-items-center mb-3">
                    <i class="material-icons text-info mr-2"></i>Your Generated Videos
                  </h6>

                  <% if (videoArray.length === 0) { %>
                    <p class="text-muted">No videos generated yet. Create your first animation above!</p>
                  <% } else { %>
                    <% videoArray.forEach(video => { %>
                    <div class="video-item mb-4 p-3 border rounded" id="video-<%= video.id %>">
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                          <label class="font-weight-bold">Prompt:</label>
                          <p class="mb-1"><%= video.videoName %></p>
                          <% if (video.createdAt) { %>
                            <small class="text-muted">Created: <%= new Date(video.createdAt).toLocaleDateString() %></small>
                          <% } %>
                        </div>
                        <button
                          class="btn btn-sm btn-danger"
                          onclick="deleteVideo(<%= video.id %>)"
                          title="Delete video"
                        >
                          Delete
                        </button>
                      </div>
                      <label class="font-weight-bold">Preview:</label>
                      <video width="100%" height="auto" controls>
                        <source src="<%= video.videoUrl %>" type="video/mp4" />
                        Your browser does not support the video tag.
                      </video>
                    </div>
                    <% }); %>

                    <!-- Pagination -->
                    <% if (totalPages > 1) { %>
                    <nav aria-label="Video pagination">
                      <ul class="pagination justify-content-center">
                        <li class="page-item <%= !hasPrevPage ? 'disabled' : '' %>">
                          <a class="page-link" href="/profile?page=<%= currentPage - 1 %>">Previous</a>
                        </li>
                        <% for (let i = 1; i <= totalPages; i++) { %>
                          <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                            <a class="page-link" href="/profile?page=<%= i %>"><%= i %></a>
                          </li>
                        <% } %>
                        <li class="page-item <%= !hasNextPage ? 'disabled' : '' %>">
                          <a class="page-link" href="/profile?page=<%= currentPage + 1 %>">Next</a>
                        </li>
                      </ul>
                    </nav>
                    <% } %>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
